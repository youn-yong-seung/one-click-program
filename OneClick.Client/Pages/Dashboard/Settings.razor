@page "/dashboard/settings"
@layout DashboardLayout
@inject AuthApiClient AuthService
@inject TokenService TokenService
@inject UserApiClient UserService
@inject UpdateService UpdateService
@inject NavigationManager Nav

<div class="max-w-3xl mx-auto py-8 px-4">
    <!-- 1. Profile & Subscription Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-gray-900 to-gray-800 p-8 text-white flex items-center gap-6">
            <div class="w-20 h-20 rounded-full bg-white/10 flex items-center justify-center text-3xl font-bold border-2 border-white/20">
                <i class="fa-solid fa-user"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold">@profile.Username</h2>
                <p class="text-gray-300 text-sm mt-1">
                    <i class="fa-solid fa-calendar-check mr-1"></i> 가입일: @profile.JoinDate.ToLocalTime().ToString("yyyy년 MM월 dd일")
                </p>
            </div>
        </div>
        
        <div class="p-6 bg-gray-50 border-t border-gray-200">
             <div class="flex items-center justify-between">
                <div>
                     <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">현재 구독 플랜</p>
                     <h3 class="text-xl font-bold text-indigo-600 flex items-center gap-2">
                        @if(profile.IsAllPass) { <i class="fa-solid fa-crown text-yellow-500"></i> }
                        @profile.PlanName
                     </h3>
                     @if(profile.ExpiryDate.HasValue) {
                         <p class="text-sm text-gray-500 mt-1">@profile.ExpiryDate.Value.ToLocalTime().ToString("yyyy.MM.dd tt h:mm") 만료 예정</p>
                     }
                </div>
                
                @if(!profile.HasActiveSubscription) {
                     <a href="/dashboard/subscription" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm shadow hover:bg-indigo-700 transition">
                         구독하기
                     </a>
                } else {
                     <button class="px-5 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-50 transition">
                         관리
                     </button>
                }
             </div>
        </div>
    </div>

    <!-- 2. Password Change Section -->
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-8">
        <div class="flex items-center gap-3 mb-6 border-b border-gray-100 pb-4">
            <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                <i class="fa-solid fa-key"></i>
            </div>
            <h2 class="text-lg font-bold text-gray-800">보안 설정</h2>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">현재 비밀번호</label>
                <input type="password" @bind="currentPassword" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="현재 비밀번호 입력" />
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">새 비밀번호</label>
                    <input type="password" @bind="newPassword" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="새 비밀번호 입력" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">새 비밀번호 확인</label>
                    <input type="password" @bind="confirmPassword" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="새 비밀번호 확인" />
                </div>
            </div>

            @if (!string.IsNullOrEmpty(message))
            {
                <div class="@(isError ? "bg-red-50 text-red-600 border-red-200" : "bg-green-50 text-green-600 border-green-200") border p-3 rounded-lg text-sm font-medium flex items-center gap-2 animate-pulse">
                    <i class="fa-solid @(isError ? "fa-circle-exclamation" : "fa-circle-check")"></i>
                    @message
                </div>
            }

            <div class="pt-2 flex justify-end">
                <button @onclick="ChangePassword" disabled="@isProcessing" class="px-6 py-3 bg-gray-900 text-white rounded-xl font-bold hover:bg-indigo-600 transition shadow-md hover:shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2">
                    @if (isProcessing)
                    {
                        <i class="fa-solid fa-circle-notch fa-spin"></i> <span>처리 중...</span>
                    }
                    else
                    {
                        <span>비밀번호 변경</span>
                    }
                </button>
            </div>
        </div>
    </div>

    <!-- 3. Auto-Update Section -->
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-8">
        <div class="flex items-center gap-3 mb-6 border-b border-gray-100 pb-4">
            <div class="p-2 bg-green-50 rounded-lg text-green-600">
                <i class="fa-solid fa-download"></i>
            </div>
            <h2 class="text-lg font-bold text-gray-800">자동 업데이트</h2>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">현재 버전</label>
                <p class="text-lg font-bold text-gray-900">@currentVersion</p>
            </div>
            
            @if (updateAvailable)
            {
                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                    <p class="text-green-800 font-medium mb-2">
                        <i class="fa-solid fa-check-circle mr-2"></i>
                        새 버전 @latestVersion 이(가) 준비되었습니다!
                    </p>
                    <button @onclick="RestartAndUpdate" 
                            class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition shadow-md">
                        <i class="fa-solid fa-rotate-right mr-2"></i>지금 재시작하고 업데이트
                    </button>
                </div>
            }
            else if (isCheckingUpdate)
            {
                <p class="text-gray-600 flex items-center gap-2">
                    <i class="fa-solid fa-spinner fa-spin"></i>업데이트 확인 중...
                </p>
            }
            else if (!string.IsNullOrEmpty(updateMessage))
            {
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <p class="text-blue-800">
                        <i class="fa-solid fa-info-circle mr-2"></i>@updateMessage
                    </p>
                </div>
            }
            
            <div class="pt-2">
                <button @onclick="CheckForUpdates" 
                        disabled="@isCheckingUpdate"
                        class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2">
                    <i class="fa-solid fa-sync"></i>
                    <span>업데이트 확인</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 4. Logout Section -->
    <div class="flex justify-end">
        <button @onclick="Logout" class="px-6 py-2 text-red-500 hover:text-red-700 font-medium transition flex items-center gap-2">
            <i class="fa-solid fa-right-from-bracket"></i> 계정 로그아웃
        </button>
    </div>
</div>

@code {
    private SubscriptionStatusDto profile = new();
    
    private string currentPassword = "";
    private string newPassword = "";
    private string confirmPassword = "";
    private string message = "";
    private bool isError = false;
    private bool isProcessing = false;
    
    // Update-related variables
    private string currentVersion = "Unknown";
    private string latestVersion = "";
    private bool updateAvailable = false;
    private bool isCheckingUpdate = false;
    private string updateMessage = "";
    private Velopack.UpdateInfo? pendingUpdate;

    protected override async Task OnInitializedAsync()
    {
        // Load User Profile
        profile = await UserService.GetSubscriptionStatusAsync();
        
        // Load current version
        currentVersion = UpdateService.GetCurrentVersion();
        
        // Auto-check for updates in background (3 seconds delay)
        _ = CheckForUpdatesInBackground();
    }

    private async Task ChangePassword()
    {
        isProcessing = true;
        message = "";
        isError = false;

        if (string.IsNullOrWhiteSpace(currentPassword) || string.IsNullOrWhiteSpace(newPassword))
        {
            message = "모든 필드를 입력해주세요.";
            isError = true;
            isProcessing = false;
            return;
        }

        if (newPassword != confirmPassword)
        {
            message = "새 비밀번호가 일치하지 않습니다.";
            isError = true;
            isProcessing = false;
            return;
        }

        if (newPassword.Length < 6)
        {
             message = "비밀번호는 6자 이상이어야 합니다.";
             isError = true;
             isProcessing = false;
             return;
        }

        try
        {
            var response = await AuthService.ChangePasswordAsync(currentPassword, newPassword);
            if (response.IsSuccessStatusCode)
            {
                message = "비밀번호가 성공적으로 변경되었습니다.";
                isError = false;
                currentPassword = "";
                newPassword = "";
                confirmPassword = "";
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                message = string.IsNullOrEmpty(errorMsg) ? "비밀번호 변경에 실패했습니다." : errorMsg;
                isError = true;
            }
        }
        catch (Exception ex)
        {
            message = $"오류 발생: {ex.Message}";
            isError = true;
        }
        
        isProcessing = false;
    }

    private void Logout()
    {
        TokenService.ClearTokens();
        Nav.NavigateTo("/login");
    }
    
    // Update-related methods
    private async Task CheckForUpdatesInBackground()
    {
        await Task.Delay(3000); // Wait 3 seconds after page load
        await CheckForUpdates();
    }
    
    private async Task CheckForUpdates()
    {
        isCheckingUpdate = true;
        updateMessage = "";
        updateAvailable = false;
        StateHasChanged();
        
        try
        {
            pendingUpdate = await UpdateService.CheckForUpdatesAsync();
            
            if (pendingUpdate != null)
            {
                latestVersion = pendingUpdate.TargetFullRelease.Version.ToString();
                
                // Download update in background
                await UpdateService.DownloadUpdatesAsync(pendingUpdate);
                
                updateAvailable = true;
                updateMessage = "";
            }
            else
            {
                updateMessage = "최신 버전을 사용 중입니다.";
            }
        }
        catch (Exception ex)
        {
            updateMessage = $"업데이트 확인 실패: {ex.Message}";
        }
        
        isCheckingUpdate = false;
        StateHasChanged();
    }
    
    private void RestartAndUpdate()
    {
        if (pendingUpdate != null)
        {
            UpdateService.ApplyUpdatesAndRestart(pendingUpdate);
        }
    }
}
